<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FLA Viewer</title>
  <style>
    :root {
      --bg-primary: #1a1a1a;
      --bg-secondary: #242424;
      --bg-tertiary: #2d2d2d;
      --border-color: #3a3a3a;
      --text-primary: #e0e0e0;
      --text-secondary: #888;
      --accent: #4a9eff;
      --accent-hover: #6bb3ff;
      --accent-dim: rgba(74, 158, 255, 0.15);
      --success: #4caf50;
      --warning: #ff9800;
      --font-mono: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
      --font-ui: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      --control-height: 44px;
      --border-radius: 4px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: var(--font-ui);
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      overflow: hidden;
    }

    /* Embed mode - add ?embed=true to URL */
    body.embed-mode .fla-header,
    body.embed-mode .drop-zone small {
      display: none;
    }
    body.embed-mode .fla-viewer {
      height: 100vh;
    }

    .fla-viewer {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    .fla-header {
      height: 36px;
      display: flex;
      align-items: center;
      padding: 0 12px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      font-size: 12px;
      font-weight: 500;
      color: var(--text-secondary);
      flex-shrink: 0;
    }

    .fla-header .logo {
      color: var(--text-primary);
      letter-spacing: 0.5px;
    }

    .fla-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
    }

    /* Drop Zone */
    .drop-zone {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: var(--bg-primary);
      cursor: pointer;
      transition: background 0.2s;
      z-index: 10;
    }

    .drop-zone.hidden {
      display: none;
    }

    .drop-zone:hover,
    .drop-zone.dragover {
      background: var(--accent-dim);
    }

    .drop-zone-content {
      text-align: center;
      padding: 40px;
      border: 1px dashed var(--border-color);
      border-radius: 8px;
      transition: border-color 0.2s;
    }

    .drop-zone:hover .drop-zone-content,
    .drop-zone.dragover .drop-zone-content {
      border-color: var(--accent);
    }

    .drop-zone-icon {
      width: 48px;
      height: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .drop-zone p {
      font-size: 14px;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .drop-zone small {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .load-sample-btn {
      display: block;
      margin: 16px auto 0;
      background: transparent;
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      padding: 6px 16px;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 11px;
      transition: all 0.15s;
    }

    .load-sample-btn:hover {
      background: var(--bg-tertiary);
      border-color: var(--accent);
    }

    #file-input {
      display: none;
    }

    /* Loading */
    .loading-overlay {
      position: absolute;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(26, 26, 26, 0.9);
      z-index: 20;
    }

    .loading-overlay.active {
      display: flex;
    }

    .loading-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      font-size: 13px;
      color: var(--text-secondary);
      min-width: 280px;
    }

    .loading-stages {
      display: flex;
      gap: 4px;
      margin-bottom: 4px;
    }

    .loading-stage {
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 3px;
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      opacity: 0.5;
      transition: all 0.2s;
    }

    .loading-stage.active {
      background: var(--accent);
      color: #000;
      opacity: 1;
    }

    .loading-stage.done {
      background: var(--success);
      color: #000;
      opacity: 0.8;
    }

    .loading-progress-bar {
      width: 100%;
      height: 3px;
      background: var(--bg-tertiary);
      border-radius: 2px;
      overflow: hidden;
    }

    .loading-progress-fill {
      height: 100%;
      width: 0%;
      background: var(--accent);
      transition: width 0.2s ease-out;
    }

    .loading-status {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid var(--border-color);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .skip-images-btn {
      background: transparent;
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      padding: 6px 16px;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 12px;
      transition: all 0.15s;
      margin-top: 12px;
    }

    .skip-images-btn:hover {
      background: var(--bg-tertiary);
      border-color: var(--accent);
    }

    .skip-images-btn.hidden {
      display: none;
    }

    /* Viewport */
    .viewport {
      flex: 1;
      display: none;
      flex-direction: column;
      background: #000;
      position: relative;
    }

    .viewport.active {
      display: flex;
    }

    .canvas-container {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    #stage {
      display: block;
      max-width: 100%;
      max-height: 100%;
    }

    /* Transport Controls */
    .transport {
      height: var(--control-height);
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 0 12px;
      background: var(--bg-secondary);
      border-top: 1px solid var(--border-color);
      flex-shrink: 0;
    }

    .transport-btn {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.15s;
      font-size: 11px;
    }

    .transport-btn:hover {
      background: var(--bg-tertiary);
      border-color: var(--accent);
    }

    .transport-btn.primary {
      background: var(--accent);
      border-color: var(--accent);
      width: 32px;
      height: 32px;
    }

    .transport-btn.primary:hover {
      background: var(--accent-hover);
    }

    .transport-btn.active {
      background: var(--success);
      border-color: var(--success);
    }

    .transport-btn svg {
      width: 14px;
      height: 14px;
      fill: currentColor;
    }

    .transport-btn.primary svg {
      width: 16px;
      height: 16px;
    }

    /* Timeline Scrubber */
    .timeline-container {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 0 8px;
    }

    .timeline {
      flex: 1;
      height: 4px;
      background: var(--bg-tertiary);
      border-radius: 2px;
      cursor: pointer;
      position: relative;
    }

    .timeline:hover {
      height: 6px;
    }

    .timeline-progress {
      height: 100%;
      background: var(--accent);
      border-radius: 2px;
      width: 0%;
      position: relative;
    }

    .timeline-progress::after {
      content: '';
      position: absolute;
      right: -4px;
      top: 50%;
      transform: translateY(-50%);
      width: 8px;
      height: 8px;
      background: var(--accent);
      border-radius: 50%;
      opacity: 0;
      transition: opacity 0.15s;
    }

    .timeline:hover .timeline-progress::after {
      opacity: 1;
    }

    /* Timecode Display */
    .timecode {
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--text-secondary);
      min-width: 90px;
      text-align: right;
      user-select: none;
    }

    .timecode .current {
      color: var(--text-primary);
    }

    /* Transport Divider */
    .transport-divider {
      width: 1px;
      height: 20px;
      background: var(--border-color);
      margin: 0 4px;
    }

    /* Volume Control */
    .volume-control {
      display: flex;
      align-items: center;
      width: 80px;
    }

    .volume-control input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 4px;
      background: var(--bg-tertiary);
      border-radius: 2px;
      outline: none;
      cursor: pointer;
    }

    .volume-control input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 12px;
      height: 12px;
      background: var(--accent);
      border-radius: 50%;
      cursor: pointer;
      transition: transform 0.1s;
    }

    .volume-control input[type="range"]::-webkit-slider-thumb:hover {
      transform: scale(1.2);
    }

    .volume-control input[type="range"]::-moz-range-thumb {
      width: 12px;
      height: 12px;
      background: var(--accent);
      border-radius: 50%;
      border: none;
      cursor: pointer;
    }

    .transport-btn.muted svg {
      opacity: 0.5;
    }

    /* Control Containers */
    .video-controls,
    .audio-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .video-controls {
      flex: 1;
    }

    .video-controls.hidden,
    .audio-controls.hidden,
    .scene-controls.hidden {
      display: none;
    }

    /* Scene Controls */
    .scene-controls {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .scene-info {
      font-family: var(--font-mono);
      font-size: 10px;
      color: var(--text-secondary);
      min-width: 80px;
      text-align: center;
      user-select: none;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .scene-info .scene-current {
      color: var(--text-primary);
      font-weight: 500;
    }

    .scene-info .scene-name {
      color: var(--accent);
      font-size: 9px;
      margin-left: 4px;
    }

    /* Info Bar */
    .info-bar {
      height: 24px;
      display: flex;
      align-items: center;
      padding: 0 12px;
      background: var(--bg-tertiary);
      border-top: 1px solid var(--border-color);
      font-size: 11px;
      color: var(--text-secondary);
      gap: 16px;
      flex-shrink: 0;
    }

    .info-bar span {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .info-bar .label {
      color: var(--text-secondary);
    }

    .info-bar .value {
      color: var(--text-primary);
    }

    /* Debug Panel */
    .debug-panel {
      display: none;
      position: absolute;
      right: 8px;
      top: 8px;
      width: 260px;
      max-height: calc(100% - 16px);
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      overflow: hidden;
      z-index: 100;
      font-size: 11px;
    }

    .debug-panel.active {
      display: flex;
      flex-direction: column;
    }

    .debug-panel-header {
      padding: 8px 10px;
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border-color);
    }

    .debug-panel-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .debug-close-btn {
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-size: 18px;
      cursor: pointer;
      padding: 0 4px;
      line-height: 1;
    }

    .debug-close-btn:hover {
      color: var(--text-primary);
    }

    .debug-panel-header .row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }

    .debug-panel-header .row:last-child {
      margin-bottom: 0;
    }

    .debug-panel-header label {
      color: var(--text-secondary);
      min-width: 55px;
    }

    .debug-panel-header select {
      flex: 1;
      background: var(--bg-primary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      padding: 3px 6px;
      font-size: 10px;
    }

    .debug-panel-header select:focus {
      outline: none;
      border-color: var(--accent);
    }

    .camera-section {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid var(--border-color);
    }

    .camera-section label {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      color: var(--text-primary);
    }

    .camera-section input[type="checkbox"] {
      accent-color: var(--accent);
    }

    .camera-info {
      font-size: 10px;
      color: var(--text-secondary);
      margin-top: 4px;
      margin-left: 18px;
    }

    .debug-panel-content {
      overflow-y: auto;
      flex: 1;
      padding: 6px;
    }

    .layer-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 6px;
      border-radius: var(--border-radius);
      cursor: pointer;
    }

    .layer-item:hover {
      background: var(--accent-dim);
    }

    .layer-item.folder {
      color: #4FC3F7;
      font-style: italic;
    }

    .layer-item.guide {
      color: var(--text-secondary);
      text-decoration: line-through;
    }

    .layer-item input[type="checkbox"] {
      accent-color: var(--accent);
    }

    .layer-item .layer-index {
      color: var(--text-secondary);
      font-family: var(--font-mono);
      font-size: 9px;
      min-width: 18px;
    }

    .layer-item .layer-color {
      width: 10px;
      height: 10px;
      border-radius: 2px;
      flex-shrink: 0;
    }

    .layer-item .layer-name {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .layer-item .layer-parent {
      color: var(--text-secondary);
      font-size: 9px;
    }

    .render-order {
      background: var(--accent);
      color: #fff;
      font-size: 8px;
      font-weight: 600;
      padding: 1px 4px;
      border-radius: 3px;
    }

    /* Layer collapse/expand */
    .layer-item .layer-toggle {
      width: 14px;
      height: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text-secondary);
      font-size: 10px;
      flex-shrink: 0;
      user-select: none;
      transition: transform 0.15s ease;
    }

    .layer-item .layer-toggle:hover {
      color: var(--text-primary);
    }

    .layer-item .layer-toggle.collapsed {
      transform: rotate(-90deg);
    }

    .layer-item .layer-toggle.no-children {
      visibility: hidden;
    }

    /* Nested element items */
    .layer-elements {
      display: none;
      margin-left: 20px;
      border-left: 1px solid var(--border-color);
      padding-left: 6px;
    }

    .layer-elements.expanded {
      display: block;
    }

    .element-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 3px 6px;
      border-radius: var(--border-radius);
      font-size: 10px;
    }

    .element-item:hover {
      background: var(--accent-dim);
    }

    .element-item input[type="checkbox"] {
      accent-color: var(--accent);
    }

    .element-item .element-id {
      color: var(--text-secondary);
      font-family: var(--font-mono);
      font-size: 8px;
      min-width: 24px;
    }

    .element-item .element-type {
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      font-size: 8px;
      padding: 1px 4px;
      border-radius: 3px;
      text-transform: uppercase;
    }

    .element-item .element-type.symbol {
      background: #4CAF50;
      color: #fff;
    }

    .element-item .element-type.shape {
      background: #2196F3;
      color: #fff;
    }

    .element-item .element-type.bitmap {
      background: #FF9800;
      color: #fff;
    }

    .element-item .element-type.text {
      background: #9C27B0;
      color: #fff;
    }

    .element-item .element-type.video {
      background: #F44336;
      color: #fff;
    }

    .element-item .element-name {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      color: var(--text-primary);
    }

    /* Nested symbol content */
    .element-item .element-toggle {
      width: 12px;
      height: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text-secondary);
      font-size: 8px;
      flex-shrink: 0;
      user-select: none;
      transition: transform 0.15s ease;
    }

    .element-item .element-toggle:hover {
      color: var(--text-primary);
    }

    .element-item .element-toggle.collapsed {
      transform: rotate(-90deg);
    }

    .element-item .element-toggle.no-children {
      visibility: hidden;
    }

    .symbol-content {
      display: none;
      margin-left: 12px;
      border-left: 1px dashed var(--border-color);
      padding-left: 6px;
      margin-top: 2px;
    }

    .symbol-content.expanded {
      display: block;
    }

    .symbol-layer {
      font-size: 9px;
      color: var(--text-secondary);
      padding: 2px 4px;
      margin: 1px 0;
    }

    .symbol-layer .sym-layer-name {
      color: var(--text-primary);
    }

    .symbol-layer .sym-layer-color {
      width: 8px;
      height: 8px;
      border-radius: 2px;
      display: inline-block;
      margin-right: 4px;
      vertical-align: middle;
    }

    /* Deeper nesting */
    .symbol-content .element-item {
      font-size: 9px;
      padding: 2px 4px;
    }

    .symbol-content .element-type {
      font-size: 7px;
      padding: 0px 3px;
    }

    .symbol-content .element-id {
      font-size: 7px;
      min-width: 18px;
    }

    /* Export Modal */
    .export-modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
    }

    .export-modal.active {
      display: flex;
    }

    .export-content {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 24px 32px;
      min-width: 320px;
      text-align: center;
    }

    .export-header {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 20px;
      color: var(--text-primary);
    }

    .export-progress-bar {
      height: 8px;
      background: var(--bg-tertiary);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 12px;
    }

    .export-progress-fill {
      height: 100%;
      background: var(--accent);
      width: 0%;
      transition: width 0.1s ease-out;
    }

    .export-status {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 20px;
    }

    .export-cancel-btn {
      background: transparent;
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      padding: 8px 24px;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 13px;
      transition: all 0.15s;
    }

    .export-cancel-btn:hover {
      background: var(--bg-tertiary);
      border-color: var(--accent);
    }

    .export-format-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 20px;
      text-align: left;
    }

    .export-format-option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: all 0.15s;
    }

    .export-format-option:hover {
      border-color: var(--accent);
    }

    .export-format-option:has(input:checked) {
      border-color: var(--accent);
      background: rgba(0, 122, 255, 0.1);
    }

    .export-format-option input[type="radio"] {
      accent-color: var(--accent);
      width: 16px;
      height: 16px;
    }

    .export-format-label {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .export-format-label strong {
      color: var(--text-primary);
      font-size: 14px;
    }

    .export-format-label small {
      color: var(--text-secondary);
      font-size: 12px;
    }

    .export-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    .export-start-btn {
      background: var(--accent);
      border: none;
      color: white;
      padding: 8px 24px;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.15s;
    }

    .export-start-btn:hover {
      background: #0066cc;
    }

    /* Download button hidden state */
    .transport-btn.hidden {
      display: none;
    }

    /* Mobile styles */
    @media (max-width: 768px) {
      /* Fit viewport */
      body {
        min-height: 100dvh;
        min-height: -webkit-fill-available;
      }

      .fla-viewer {
        height: 100dvh;
        height: -webkit-fill-available;
      }

      /* Hide header on mobile for more space */
      .fla-header {
        height: 28px;
        padding: 0 8px;
        font-size: 11px;
      }

      /* Hide stop button on mobile */
      #stop-btn {
        display: none;
      }

      /* Hide audio controls on mobile */
      .audio-controls {
        display: none !important;
      }

      /* Compact transport bar */
      .transport {
        height: 40px;
        padding: 0 8px;
        gap: 6px;
      }

      /* Smaller buttons on mobile */
      .transport-btn {
        width: 32px;
        height: 32px;
      }

      .transport-btn.primary {
        width: 36px;
        height: 36px;
      }

      /* Smaller timeline gap */
      .timeline-container {
        margin: 0 4px;
        gap: 8px;
      }

      /* Compact timecode */
      .timecode {
        min-width: 70px;
        font-size: 10px;
      }

      /* Smaller info bar */
      .info-bar {
        height: 20px;
        padding: 0 8px;
        font-size: 10px;
        gap: 8px;
        overflow-x: auto;
        flex-wrap: nowrap;
      }

      .info-bar span {
        white-space: nowrap;
      }

      /* Debug panel adjustments for mobile */
      .debug-panel {
        width: 220px;
        right: 4px;
        top: 4px;
        max-height: calc(100% - 8px);
        font-size: 10px;
      }

      /* Drop zone adjustments */
      .drop-zone-content {
        padding: 24px;
      }

      .drop-zone-icon {
        width: 40px;
        height: 40px;
        margin-bottom: 12px;
      }

      .drop-zone p {
        font-size: 13px;
      }

      .drop-zone small {
        font-size: 11px;
      }

      /* Export modal adjustments */
      .export-content {
        padding: 20px 24px;
        min-width: 280px;
        margin: 0 16px;
      }
    }

    /* Extra small screens (phones in portrait) */
    @media (max-width: 480px) {
      .fla-header {
        display: none;
      }

      .transport {
        height: 44px;
        padding: 0 6px;
      }

      /* Hide download button on very small screens */
      #download-btn {
        display: none;
      }

      .timecode {
        min-width: 60px;
        font-size: 9px;
      }

      .info-bar {
        display: none;
      }

      .debug-panel {
        width: 180px;
      }
    }
  </style>
</head>
<body>
  <div class="fla-viewer">
    <header class="fla-header">
      <span class="logo">FLA Viewer</span>
    </header>

    <main class="fla-main">
      <div class="drop-zone" id="drop-zone">
        <div class="drop-zone-content">
          <svg class="drop-zone-icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/>
          </svg>
          <p>Drop FLA file here or click to browse</p>
          <small>Supports Adobe Animate/Flash FLA files</small>
          <button class="load-sample-btn" id="load-sample-btn">Sample</button>
        </div>
        <input type="file" id="file-input" accept=".fla">
      </div>

      <div class="loading-overlay" id="loading">
        <div class="loading-content">
          <div class="loading-stages" id="loading-stages">
            <div class="loading-stage" data-stage="extract">Extract</div>
            <div class="loading-stage" data-stage="symbols">Symbols</div>
            <div class="loading-stage" data-stage="images">Images</div>
            <div class="loading-stage" data-stage="audio">Audio</div>
            <div class="loading-stage" data-stage="timeline">Timeline</div>
          </div>
          <div class="loading-progress-bar">
            <div class="loading-progress-fill" id="loading-progress-fill"></div>
          </div>
          <div class="loading-status">
            <div class="spinner"></div>
            <span id="loading-text">Loading...</span>
          </div>
          <button class="skip-images-btn hidden" id="skip-images-btn">Skip images fix</button>
        </div>
      </div>

      <div class="export-modal" id="export-modal">
        <div class="export-content">
          <div class="export-header" id="export-header">Export</div>

          <!-- Export Options (shown first) -->
          <div class="export-options" id="export-options">
            <div class="export-format-group">
              <label class="export-format-option">
                <input type="radio" name="export-format" value="mp4" checked>
                <span class="export-format-label">
                  <strong>MP4 Video</strong>
                  <small>H.264 video with audio</small>
                </span>
              </label>
              <label class="export-format-option">
                <input type="radio" name="export-format" value="webm">
                <span class="export-format-label">
                  <strong>WebM Video</strong>
                  <small>VP9 video with Opus audio</small>
                </span>
              </label>
              <label class="export-format-option">
                <input type="radio" name="export-format" value="png-sequence">
                <span class="export-format-label">
                  <strong>PNG Sequence</strong>
                  <small>Frames as numbered PNGs in ZIP</small>
                </span>
              </label>
              <label class="export-format-option">
                <input type="radio" name="export-format" value="png-frame">
                <span class="export-format-label">
                  <strong>Current Frame (PNG)</strong>
                  <small>Single PNG of current frame</small>
                </span>
              </label>
              <label class="export-format-option">
                <input type="radio" name="export-format" value="svg">
                <span class="export-format-label">
                  <strong>Current Frame (SVG)</strong>
                  <small>Vector format of current frame</small>
                </span>
              </label>
              <label class="export-format-option">
                <input type="radio" name="export-format" value="gif">
                <span class="export-format-label">
                  <strong>Animated GIF</strong>
                  <small>Animated image (no audio)</small>
                </span>
              </label>
              <label class="export-format-option">
                <input type="radio" name="export-format" value="sprite-sheet">
                <span class="export-format-label">
                  <strong>Sprite Sheet</strong>
                  <small>Texture atlas with JSON metadata</small>
                </span>
              </label>
            </div>
            <div class="export-buttons">
              <button class="export-start-btn" id="export-start-btn">Export</button>
              <button class="export-cancel-btn" id="export-close-btn">Cancel</button>
            </div>
          </div>

          <!-- Export Progress (shown during export) -->
          <div class="export-progress" id="export-progress" style="display: none;">
            <div class="export-progress-bar">
              <div class="export-progress-fill" id="export-progress-fill"></div>
            </div>
            <div class="export-status" id="export-status">Preparing...</div>
            <button class="export-cancel-btn" id="export-cancel-btn">Cancel</button>
          </div>
        </div>
      </div>

      <div class="viewport" id="viewer">
        <div class="canvas-container">
          <canvas id="stage"></canvas>
        </div>

        <div class="debug-panel" id="debug-panel">
          <div class="debug-panel-header">
            <div class="debug-panel-title">
              <span>Debug Panel</span>
              <button class="debug-close-btn" id="debug-close-btn" title="Close">&times;</button>
            </div>
            <div class="row">
              <label>Main:</label>
              <select id="layer-order-select">
                <option value="reverse">Reverse</option>
                <option value="forward">Forward</option>
              </select>
            </div>
            <div class="row">
              <label>Nested:</label>
              <select id="nested-order-select">
                <option value="reverse">Reverse</option>
                <option value="forward">Forward</option>
              </select>
            </div>
            <div class="row">
              <label>Elements:</label>
              <select id="element-order-select">
                <option value="forward">Forward</option>
                <option value="reverse">Reverse</option>
              </select>
            </div>
            <div class="camera-section">
              <label>
                <input type="checkbox" id="follow-camera-checkbox">
                <span>Follow Camera</span>
              </label>
              <div class="camera-info" id="camera-layer-info"></div>
            </div>
            <div class="camera-section">
              <label>
                <input type="checkbox" id="edge-debug-checkbox">
                <span>Edge Debug</span>
              </label>
            </div>
            <div class="camera-section">
              <label>
                <input type="checkbox" id="implicit-moveto-checkbox">
                <span>Implicit MoveTo</span>
              </label>
            </div>
            <div class="camera-section">
              <label>
                <input type="checkbox" id="edge-splitting-checkbox">
                <span>Edge Splitting</span>
              </label>
            </div>
          </div>
          <div class="debug-panel-content" id="layer-list"></div>
        </div>

        <div class="transport">
          <div class="video-controls" id="video-controls">
            <button class="transport-btn" id="stop-btn" title="Stop">
              <svg viewBox="0 0 24 24"><rect x="6" y="6" width="12" height="12"/></svg>
            </button>
            <button class="transport-btn" id="prev-btn" title="Previous Frame">
              <svg viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
            </button>
            <button class="transport-btn primary" id="play-btn" title="Play/Pause">
              <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
            </button>
            <button class="transport-btn" id="next-btn" title="Next Frame">
              <svg viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
            </button>

            <div class="scene-controls hidden" id="scene-controls">
              <div class="transport-divider"></div>
              <button class="transport-btn" id="prev-scene-btn" title="Previous Scene (Page Up)">
                <svg viewBox="0 0 24 24"><path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z"/></svg>
              </button>
              <span class="scene-info" id="scene-info">1/1</span>
              <button class="transport-btn" id="next-scene-btn" title="Next Scene (Page Down)">
                <svg viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
              </button>
            </div>

            <div class="timeline-container">
              <div class="timeline" id="timeline">
                <div class="timeline-progress" id="timeline-progress"></div>
              </div>
            </div>

            <div class="timecode" id="frame-info">
              <span class="current">1</span> / 1
            </div>
          </div>

          <div class="audio-controls" id="audio-controls">
            <div class="transport-divider"></div>

            <button class="transport-btn" id="mute-btn" title="Mute/Unmute (M)">
              <svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
            </button>

            <div class="volume-control">
              <input type="range" id="volume-slider" min="0" max="100" value="100" title="Volume">
            </div>
          </div>

          <button class="transport-btn" id="download-btn" title="Download as MP4">
            <svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
          </button>

          <button class="transport-btn" id="debug-btn" title="Debug Panel (D)">
            <svg viewBox="0 0 24 24"><path d="M20 8h-2.81c-.45-.78-1.07-1.45-1.82-1.96L17 4.41 15.59 3l-2.17 2.17C12.96 5.06 12.49 5 12 5c-.49 0-.96.06-1.41.17L8.41 3 7 4.41l1.62 1.63C7.88 6.55 7.26 7.22 6.81 8H4v2h2.09c-.05.33-.09.66-.09 1v1H4v2h2v1c0 .34.04.67.09 1H4v2h2.81c1.04 1.79 2.97 3 5.19 3s4.15-1.21 5.19-3H20v-2h-2.09c.05-.33.09-.66.09-1v-1h2v-2h-2v-1c0-.34-.04-.67-.09-1H20V8zm-6 8h-4v-2h4v2zm0-4h-4v-2h4v2z"/></svg>
          </button>

          <button class="transport-btn" id="fullscreen-btn" title="Fullscreen (F)">
            <svg viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>
          </button>
        </div>

        <div class="info-bar" id="info-panel"></div>
      </div>
    </main>
  </div>

  <script>
    // Check for embed mode
    if (new URLSearchParams(window.location.search).get('embed') === 'true') {
      document.body.classList.add('embed-mode');
    }
  </script>
  <script type="module" src="/src/main.ts"></script>
</body>
</html>
